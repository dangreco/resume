---
# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
# yamllint disable rule:line-length
# yamllint disable rule:comments
name: PR
on:
  pull_request:
jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      deployments: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Create GitHub deployment
        uses: chrnorm/deployment-action@v2.0.7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: Preview
          description: "Preview for PR #${{ github.event.pull_request.number }}"

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@9596b92e70cbf68a494a2b0273cb5b680184f5fc # v3.13.1

      - name: Initialize Nix shell
        run: nix develop .#ci --command true

      - name: Build PDF
        run: nix develop .#ci --command task typst:build

      - name: Upload to S3
        uses: shallwefootball/s3-upload-action@v1.3.3
        with:
          aws_key_id: ${{ secrets.AWS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_bucket: ${{ secrets.AWS_BUCKET }}
          source_dir: "_build"
          destination_dir: "pr-${{ github.event.pull_request.number }}"

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: resume-pr-${{ github.event.pull_request.number }}
          path: _build/resume.en.pdf
          retention-days: 30

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment-url: https://${{ secrets.AWS_BUCKET }}.s3.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com/pr-${{ github.event.pull_request.number }}/resume.en.pdf
          state: "success"
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          state: "failure"
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}

      - name: Comment PR with preview
        if: success()
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: resume-preview
          message: |
            ## Resume Preview
            A preview PDF has been generated and deployed for this PR.

            **ðŸ”— Live Preview:** [View PDF on S3](https://${{ secrets.AWS_BUCKET }}.s3.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com/pr-${{ github.event.pull_request.number }}/resume.en.pdf)

            **ðŸ“¦ Artifact Download:** [resume.en.pdf](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)

            <details>
            <summary>Deployment Details</summary>

            - **Environment:** `pr-${{ github.event.pull_request.number }}`
            - **Deployment ID:** `${{ steps.deployment.outputs.deployment_id }}`
            - **S3 Path:** `pr-${{ github.event.pull_request.number }}/resume.en.pdf`
            - **Run ID:** `${{ github.run_id }}`
            - **Retention:** 30 days
            </details>
