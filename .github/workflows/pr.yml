---
# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
# yamllint disable rule:line-length
# yamllint disable rule:comments
name: PR
on:
  pull_request:
jobs:
  deploy-preview:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      deployments: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create GitHub deployment
        uses: chrnorm/deployment-action@55729fcebec3d284f60f5bcabbd8376437d696b1 # v2.0.7
        id: deployment
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: Preview
          description: "Preview for PR #${{ github.event.pull_request.number }}"

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@1d699fc25db3f9e079cd2f168ca007a4183389be # v3.15.1

      - name: Initialize Nix shell
        run: nix develop .#ci --command true

      - name: Build PDF
        run: nix develop .#ci --command task typst:build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          aws-access-key-id: ${{ secrets.AWS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        id: s3
        run: |
          aws s3 cp _build/resume.en.pdf s3://${{ secrets.AWS_BUCKET }}/pr-${{ github.event.pull_request.number }}/resume.en.pdf
          URL=$(aws s3 presign s3://${{ secrets.AWS_BUCKET }}/pr-${{ github.event.pull_request.number }}/resume.en.pdf --expires-in 604800)
          echo "url=$URL" >> $GITHUB_OUTPUT
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: resume-pr-${{ github.event.pull_request.number }}
          path: _build/resume.en.pdf
          retention-days: 30

      - name: Update deployment status (success)
        if: success()
        uses: chrnorm/deployment-status@9a72af4586197112e0491ea843682b5dc280d806 # v2.0.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment-url: ${{ steps.s3.outputs.url }}
          state: "success"
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}

      - name: Update deployment status (failure)
        if: failure()
        uses: chrnorm/deployment-status@9a72af4586197112e0491ea843682b5dc280d806 # v2.0.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          state: "failure"
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}

      - name: Comment PR with preview
        if: success()
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: resume-preview
          message: |
            ## Resume Preview
            A preview PDF has been generated and deployed for this PR.

            **üîó Live Preview:** [View PDF on S3](${{ steps.s3.outputs.url }})

            **üì¶ Artifact Download:** [resume.en.pdf](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)

            ‚ö†Ô∏è *Preview link expires in 7 days*

            <details>
            <summary>Deployment Details</summary>

            - **Environment:** `pr-${{ github.event.pull_request.number }}`
            - **Deployment ID:** `${{ steps.deployment.outputs.deployment_id }}`
            - **S3 Path:** `pr-${{ github.event.pull_request.number }}/resume.en.pdf`
            - **Run ID:** `${{ github.run_id }}`
            - **Retention:** 30 days
            </details>
